#cloud-config
# Spirit Tours - Cloud Init Configuration for DigitalOcean
# This file automatically configures the server on first boot

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - build-essential
  - software-properties-common
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - ufw
  - fail2ban
  - htop
  - net-tools
  - zip
  - unzip
  - jq
  - python3-pip
  - nginx
  - certbot
  - python3-certbot-nginx

users:
  - name: spirittours
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-rsa YOUR_SSH_PUBLIC_KEY_HERE

write_files:
  - path: /etc/sysctl.d/99-spirit-tours.conf
    content: |
      # Network optimizations
      net.core.somaxconn = 65535
      net.ipv4.tcp_max_syn_backlog = 8192
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_tw_reuse = 1
      net.ipv4.tcp_fin_timeout = 30
      net.ipv4.ip_local_port_range = 1024 65000
      
      # File descriptor limits
      fs.file-max = 100000
      
      # Memory optimizations
      vm.swappiness = 10
      vm.dirty_ratio = 15
      vm.dirty_background_ratio = 5

  - path: /etc/security/limits.d/99-spirit-tours.conf
    content: |
      * soft nofile 65535
      * hard nofile 65535
      * soft nproc 32768
      * hard nproc 32768
      root soft nofile 65535
      root hard nofile 65535

  - path: /home/spirittours/install.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      echo "Starting Spirit Tours installation..."
      
      # Install Docker
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
      sudo apt-get update
      sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
      
      # Install Docker Compose
      sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      sudo chmod +x /usr/local/bin/docker-compose
      
      # Install Node.js 18
      curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
      sudo apt-get install -y nodejs
      
      # Install PM2
      sudo npm install -g pm2
      
      # Clone repository
      cd /home/spirittours
      git clone https://github.com/your-org/spirit-tours.git app
      cd app
      
      # Create directories
      mkdir -p logs backups
      
      # Set permissions
      sudo chown -R spirittours:spirittours /home/spirittours
      
      echo "Installation completed!"

  - path: /etc/nginx/sites-available/spirit-tours
    content: |
      upstream api_backend {
          server 127.0.0.1:8000;
          keepalive 32;
      }
      
      upstream frontend {
          server 127.0.0.1:3000;
          keepalive 32;
      }
      
      server {
          listen 80;
          server_name _;
          
          # Security headers
          add_header X-Frame-Options "SAMEORIGIN" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header X-XSS-Protection "1; mode=block" always;
          add_header Referrer-Policy "strict-origin-when-cross-origin" always;
          
          # Gzip compression
          gzip on;
          gzip_vary on;
          gzip_min_length 1024;
          gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml application/atom+xml image/svg+xml text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype;
          
          # Rate limiting zones
          limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
          limit_req_zone $binary_remote_addr zone=general:10m rate=50r/s;
          
          # Frontend
          location / {
              limit_req zone=general burst=20 nodelay;
              proxy_pass http://frontend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_connect_timeout 60s;
              proxy_send_timeout 60s;
              proxy_read_timeout 60s;
          }
          
          # API
          location /api {
              limit_req zone=api burst=30 nodelay;
              proxy_pass http://api_backend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_connect_timeout 60s;
              proxy_send_timeout 60s;
              proxy_read_timeout 60s;
              
              # CORS headers
              add_header 'Access-Control-Allow-Origin' '$http_origin' always;
              add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
              add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
              add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
          }
          
          # WebSocket support
          location /ws {
              proxy_pass http://api_backend;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "upgrade";
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              proxy_read_timeout 86400;
          }
          
          # Health check endpoint
          location /health {
              access_log off;
              return 200 "healthy\n";
              add_header Content-Type text/plain;
          }
          
          # Static files
          location /static {
              alias /home/spirittours/app/frontend/build/static;
              expires 30d;
              add_header Cache-Control "public, immutable";
          }
          
          # Media files
          location /media {
              alias /home/spirittours/app/media;
              expires 7d;
              add_header Cache-Control "public";
          }
      }

  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      
      [sshd]
      enabled = true
      port = 22
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      
      [nginx-http-auth]
      enabled = true
      filter = nginx-http-auth
      port = http,https
      logpath = /var/log/nginx/error.log
      
      [nginx-noscript]
      enabled = true
      port = http,https
      filter = nginx-noscript
      logpath = /var/log/nginx/access.log
      maxretry = 6
      
      [nginx-badbots]
      enabled = true
      port = http,https
      filter = nginx-badbots
      logpath = /var/log/nginx/access.log
      maxretry = 2
      
      [nginx-noproxy]
      enabled = true
      port = http,https
      filter = nginx-noproxy
      logpath = /var/log/nginx/error.log
      maxretry = 2

  - path: /home/spirittours/docker-compose.override.yml
    content: |
      version: '3.8'
      services:
        api:
          environment:
            - NODE_ENV=production
            - LOG_LEVEL=info
          restart: always
          deploy:
            resources:
              limits:
                cpus: '2'
                memory: 2G
              reservations:
                cpus: '1'
                memory: 1G
        
        frontend:
          restart: always
          deploy:
            resources:
              limits:
                cpus: '1'
                memory: 1G
              reservations:
                cpus: '0.5'
                memory: 512M

  - path: /home/spirittours/backup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      BACKUP_DIR="/home/spirittours/backups"
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      
      # Create backup directory
      mkdir -p "$BACKUP_DIR"
      
      # Backup database
      docker exec spirit-tours-postgres pg_dump -U spirit_admin spirit_tours_prod | gzip > "$BACKUP_DIR/db_backup_${TIMESTAMP}.sql.gz"
      
      # Backup application files
      tar czf "$BACKUP_DIR/app_backup_${TIMESTAMP}.tar.gz" /home/spirittours/app --exclude=node_modules --exclude=.git
      
      # Keep only last 30 days of backups
      find "$BACKUP_DIR" -name "*.gz" -mtime +30 -delete
      
      echo "Backup completed: ${TIMESTAMP}"

runcmd:
  # System optimizations
  - sysctl -p /etc/sysctl.d/99-spirit-tours.conf
  
  # Configure firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable
  
  # Enable services
  - systemctl enable nginx
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Link nginx site
  - ln -sf /etc/nginx/sites-available/spirit-tours /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t && systemctl reload nginx
  
  # Run installation script
  - su - spirittours -c "/home/spirittours/install.sh"
  
  # Setup cron for backups
  - echo "0 2 * * * /home/spirittours/backup.sh >> /home/spirittours/logs/backup.log 2>&1" | crontab -u spirittours -
  
  # Create swap file (4GB)
  - fallocate -l 4G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - echo '/swapfile none swap sw 0 0' | tee -a /etc/fstab
  
  # Start Docker containers
  - cd /home/spirittours/app && docker-compose -f docker-compose.production.yml up -d

final_message: |
  Spirit Tours deployment completed!
  Server will reboot in 1 minute.
  
  Access URLs:
  - Frontend: http://$PUBLICIP
  - API: http://$PUBLICIP:8000
  - API Docs: http://$PUBLICIP:8000/docs
  
  Next steps:
  1. Configure DNS records
  2. Set up SSL certificates
  3. Update environment variables
  4. Test the deployment

power_state:
  delay: 1
  mode: reboot
  message: Rebooting after cloud-init completion
  timeout: 30
  condition: True